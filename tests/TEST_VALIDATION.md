# PSDL Test Validation Methodology

This document provides a critical analysis of PSDL test validation approaches, identifying potential weaknesses and demonstrating true independence of validation methods.

## Validation Approaches

### 1. PSDL vs SQL Comparison (`test_psdl_vs_sql.py`)

**Method**: Compare PSDL evaluator results against a hand-written SQL emulator.

**Critical Analysis**:

| Aspect | Finding | Risk Level |
|--------|---------|------------|
| Delta calculation | Both use `last - first` in window | **LOW** - Same algorithm but different implementations |
| Time windowing | Both use `reference_time - window` | **LOW** - Standard approach |
| Threshold values | SQL uses 0.3/1.0/2.0, PSDL uses same | **MEDIUM** - Values derived from same KDIGO spec |

**Potential "Cheating" Concerns**:

1. **Same Algorithm**: The SQL emulator uses the same `last - first` formula as PSDL's delta operator. This is NOT a flaw because:
   - This is the clinically correct definition of delta (change over time)
   - Both implementations were written independently
   - The SQL emulator represents what a real database query would compute

2. **Same Thresholds**: Both use KDIGO criteria (0.3 mg/dL for Stage 1). This is intentional because:
   - PSDL scenario defines these thresholds
   - SQL emulator must use same thresholds for valid comparison
   - Thresholds come from published clinical guidelines, not arbitrary choice

**Verdict**: This is **VALID** validation. The test verifies that PSDL's implementation matches what SQL would compute for the same clinical logic.

---

### 2. Synthea Validation (`test_synthea_validation.py`)

**Method**: Run PSDL scenarios against synthetic patient data generated by Synthea.

**Critical Analysis**:

| Aspect | Finding | Risk Level |
|--------|---------|------------|
| Data source | Synthea FHIR bundles (external tool) | **NONE** - Truly independent |
| LOINC mapping | Manual mapping of codes | **LOW** - Could miss codes |
| Expected outcomes | Not pre-known | **NONE** - Tests exploratory detection |

**Independence Verification**:

```
Data Flow:
Synthea (external) → FHIR JSON → LOINC mapping → PSDL Backend → Evaluator → Results
                     ^                            ^
                     |                            |
              No PSDL involvement          PSDL being tested
```

**Key Finding**: Synthea data is generated by an external tool with NO knowledge of PSDL. The 4.7% AKI detection rate reflects genuine pattern detection in synthetic data, not circular validation.

**Verdict**: This is **VALID** independent validation.

---

### 3. MIMIC-IV Validation (`test_mimic_validation.py`)

**Method**: Run PSDL scenarios against real de-identified hospital data from Beth Israel Deaconess Medical Center.

**Critical Analysis**:

| Aspect | Finding | Risk Level |
|--------|---------|------------|
| Data source | Real hospital EHR (MIMIC-IV) | **NONE** - Truly independent |
| Patient outcomes | Not available in test | **MEDIUM** - Cannot verify accuracy |
| Code mapping | MIMIC-specific codes (not LOINC) | **LOW** - Manual mapping required |

**Independence Verification**:

```
Data Flow:
MIMIC-IV (hospital) → FHIR ndjson → Code mapping → PSDL Backend → Evaluator → Results
                      ^                            ^
                      |                            |
             Real clinical data             PSDL being tested
```

**Key Finding**: MIMIC-IV is real hospital data from 2008-2019, collected BEFORE PSDL existed. The 2.4-4.7% AKI detection rate is clinically plausible for ICU populations.

**Verdict**: This is **VALID** independent validation.

---

## True Independence Tests

To further validate PSDL correctness, we include tests that use mathematically verifiable inputs:

### Test 1: Known Delta Calculation

```python
# Input: Creatinine values [1.0, 1.1, 1.2, 1.3, 1.4] over 36 hours
# Expected delta = 1.4 - 1.0 = 0.4 mg/dL
# Expected trigger: Stage 1 (delta >= 0.3)

# PSDL Result: Stage 1 triggered ✓
# SQL Result: Stage 1 triggered ✓
# Manual calculation: 0.4 >= 0.3 ✓
```

### Test 2: Known Non-Trigger

```python
# Input: Creatinine values [1.0, 1.05, 0.98, 1.02, 1.0] (stable)
# Expected delta = 1.0 - 1.0 = 0.0 mg/dL
# Expected trigger: None (delta < 0.3)

# PSDL Result: Not triggered ✓
# SQL Result: Not triggered ✓
# Manual calculation: 0.0 < 0.3 ✓
```

### Test 3: Batch Random Data

```python
# Input: 50 randomly generated patients with known patterns
# Patterns: stable, rising_mild, rising_severe, falling

# Result: 100% agreement between PSDL and SQL
# This validates the algorithm, not just edge cases
```

---

## Summary: Is PSDL "Cheating"?

**NO.** The validation approach is sound because:

1. **Algorithm Correctness**: PSDL implements clinically standard algorithms (delta, slope, threshold comparisons). The SQL comparison verifies this implementation is correct.

2. **Data Independence**: Synthea and MIMIC-IV data are generated/collected completely independently of PSDL. These are not test fixtures designed to pass.

3. **Clinical Validity**: Detection rates (2-5% AKI in ICU data) match published literature on AKI incidence in hospitalized patients.

4. **Reproducibility**: All tests use deterministic inputs and can be independently verified.

---

## Limitations Acknowledged

1. **No Ground Truth Comparison**: We don't have "true" AKI labels for Synthea/MIMIC patients to calculate sensitivity/specificity.

2. **Algorithm Equivalence**: PSDL and SQL use the same algorithm BY DESIGN. This is correct - we're verifying implementation, not algorithm choice.

3. **Threshold Validation**: We trust KDIGO thresholds without independent clinical validation in these tests.

---

## Recommended Additional Validation

For production use, PSDL should be validated against:

1. **Labeled Clinical Datasets**: Patients with known AKI diagnoses (e.g., from chart review)
2. **Multi-Site Comparison**: Run same scenario across different hospitals
3. **Temporal Validation**: Predict AKI before it occurs (prospective validation)

---

## Test Coverage Summary

| Test Suite | Tests | Independence | What It Proves |
|------------|-------|--------------|----------------|
| `test_psdl_vs_sql.py` | 6 | Algorithm match | PSDL computes same as SQL |
| `test_independent_verification.py` | 12 | Manual calculation | PSDL matches hand calculations |
| `test_all_scenarios_e2e.py` | 8 | Full pipeline | Complete workflows work |
| `test_clinical_validation.py` | 11 | Known outcomes | PSDL matches expected results |
| `test_evaluator.py` | 23 | Unit tests | Core evaluator correctness |
| `test_operators.py` | 20 | Unit tests | Temporal operators correctness |
| `test_fhir_backend.py` | 30 | Unit tests | FHIR backend correctness |
| `test_omop_backend.py` | 20 | Unit tests | OMOP backend with population filtering |
| `test_scenarios_comprehensive.py` | 20 | Comprehensive | Multi-scenario edge cases |
| `test_parser.py` | 18 | Unit tests | YAML parsing correctness |
| `test_end_to_end.py` | 18 | Integration | Full pipeline workflows |
| `test_streaming.py` | 48 | Unit tests | Streaming backend, window functions |

**Total: 234 tests (all passing)**

### Test Categories

| Category | Tests | Description |
|----------|-------|-------------|
| Unit Tests | ~180 | Parser, evaluator, operators, adapters |
| Integration Tests | ~30 | End-to-end workflows, FHIR/OMOP adapters |
| Streaming Tests | ~48 | Window functions, logic evaluation, Flink compiler |

### Running Integration Tests

```bash
# FHIR integration (requires network)
pytest tests/test_fhir_integration.py -v -m integration

# OMOP integration (requires local OMOP database on port 5434)
OMOP_LOCAL=1 pytest tests/test_omop_backend.py -v -m integration
```

### OMOP Source Value Support

The OMOP backend supports databases with unmapped concepts (where `concept_id = 0`):

```python
backend = create_omop_backend(
    connection_string="postgresql://localhost:5434/omop",
    cdm_schema="public",
    use_source_values=True,
    source_value_mappings={
        "Cr": "Creatinine",
        "Lact": "Lactate",
        "HR": "Heart Rate",
    }
)
```

### MIMIC-IV Date Shifting

MIMIC-IV data is de-identified with shifted dates (years 2100-2200). When testing:
- Use reference times like `datetime(2180, 6, 1)` instead of `datetime.now()`
- This ensures time window queries find data
