{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://psdl-lang.org/schema/v0.1/scenario",
  "title": "PSDL Scenario Schema",
  "description": "JSON Schema for Patient Scenario Definition Language (PSDL) v0.1 scenario documents",
  "type": "object",
  "required": ["scenario", "version", "signals", "logic"],
  "additionalProperties": false,

  "properties": {
    "scenario": {
      "$ref": "#/$defs/scenarioName"
    },
    "name": {
      "type": "string",
      "description": "Alternative field name for scenario identifier (alias for 'scenario')"
    },
    "version": {
      "$ref": "#/$defs/semanticVersion"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of what this scenario detects"
    },
    "population": {
      "$ref": "#/$defs/populationFilter"
    },
    "signals": {
      "$ref": "#/$defs/signalDefinitions"
    },
    "trends": {
      "$ref": "#/$defs/trendDefinitions"
    },
    "logic": {
      "$ref": "#/$defs/logicDefinitions"
    },
    "mapping": {
      "$ref": "#/$defs/mappingConfig"
    }
  },

  "$defs": {
    "scenarioName": {
      "type": "string",
      "pattern": "^[A-Za-z][A-Za-z0-9_-]*$",
      "minLength": 1,
      "maxLength": 128,
      "description": "Unique identifier for this scenario",
      "examples": ["AKI_Detection", "Sepsis_Early_Warning", "ICU_Deterioration_v1"]
    },

    "semanticVersion": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+(\\.\\d+)?$",
      "description": "Semantic version of this scenario definition",
      "examples": ["0.1", "1.0.0", "2.1.3"]
    },

    "identifier": {
      "type": "string",
      "pattern": "^[A-Za-z][A-Za-z0-9_]*$",
      "minLength": 1,
      "maxLength": 64,
      "description": "Valid identifier (starts with letter, contains letters/digits/underscores)"
    },

    "populationFilter": {
      "type": "object",
      "description": "Define which patients this scenario applies to",
      "additionalProperties": false,
      "properties": {
        "include": {
          "type": "array",
          "description": "Inclusion criteria (all must be true)",
          "items": { "type": "string" },
          "examples": [["age >= 18", "unit == 'ICU'"]]
        },
        "exclude": {
          "type": "array",
          "description": "Exclusion criteria (any excludes patient)",
          "items": { "type": "string" },
          "examples": [["status == 'comfort_care_only'"]]
        }
      }
    },

    "signalDefinitions": {
      "type": "object",
      "description": "Map logical signal names to data sources",
      "minProperties": 1,
      "additionalProperties": {
        "$ref": "#/$defs/signalSpec"
      },
      "propertyNames": {
        "$ref": "#/$defs/identifier"
      }
    },

    "signalSpec": {
      "oneOf": [
        {
          "type": "string",
          "description": "Shorthand: source identifier only"
        },
        {
          "type": "object",
          "required": ["source"],
          "additionalProperties": false,
          "properties": {
            "source": {
              "type": "string",
              "description": "Source identifier (concept name, OMOP concept_id, LOINC code, etc.)",
              "examples": ["creatinine", "3016723", "LOINC:2160-0"]
            },
            "type": {
              "type": "string",
              "enum": ["numeric", "categorical", "boolean"],
              "default": "numeric",
              "description": "Data type of signal values"
            },
            "concept_id": {
              "type": "integer",
              "minimum": 0,
              "description": "OMOP concept_id (if known)"
            },
            "unit": {
              "type": "string",
              "description": "Expected unit of measurement",
              "examples": ["mg/dL", "mmol/L", "mmHg", "bpm", "celsius"]
            },
            "domain": {
              "type": "string",
              "enum": ["measurement", "condition", "drug", "procedure", "observation"],
              "default": "measurement",
              "description": "OMOP domain for this signal"
            },
            "description": {
              "type": "string",
              "description": "Human-readable description of this signal"
            }
          }
        }
      ]
    },

    "trendDefinitions": {
      "type": "object",
      "description": "Define computed trends over signals",
      "additionalProperties": {
        "$ref": "#/$defs/trendSpec"
      },
      "propertyNames": {
        "$ref": "#/$defs/identifier"
      }
    },

    "trendSpec": {
      "oneOf": [
        {
          "$ref": "#/$defs/trendExpression",
          "description": "Shorthand: expression string only"
        },
        {
          "type": "object",
          "required": ["expr"],
          "additionalProperties": false,
          "properties": {
            "expr": {
              "$ref": "#/$defs/trendExpression"
            },
            "description": {
              "type": "string",
              "description": "Human-readable explanation of this trend"
            }
          }
        }
      ]
    },

    "trendExpression": {
      "type": "string",
      "description": "Trend expression following PSDL expression grammar (see psdl-expression.ebnf)",
      "pattern": "^(delta|slope|ema|sma|min|max|count|last|first|stddev|exists|missing)\\s*\\(",
      "examples": [
        "delta(Cr, 6h) > 0.3",
        "slope(Lact, 3h) > 0",
        "ema(MAP, 30m) < 65",
        "last(HR) > 100",
        "count(Cr, 48h) >= 2"
      ]
    },

    "logicDefinitions": {
      "type": "object",
      "description": "Boolean logic combining trends into clinical states",
      "minProperties": 1,
      "additionalProperties": {
        "$ref": "#/$defs/logicSpec"
      },
      "propertyNames": {
        "$ref": "#/$defs/identifier"
      }
    },

    "logicSpec": {
      "oneOf": [
        {
          "$ref": "#/$defs/logicExpression",
          "description": "Shorthand: expression string only"
        },
        {
          "type": "object",
          "required": ["expr"],
          "additionalProperties": false,
          "properties": {
            "expr": {
              "$ref": "#/$defs/logicExpression"
            },
            "severity": {
              "$ref": "#/$defs/severityLevel"
            },
            "description": {
              "type": "string",
              "description": "Clinical interpretation of this state"
            }
          }
        }
      ]
    },

    "logicExpression": {
      "type": "string",
      "description": "Boolean expression combining trends (see psdl-expression.ebnf)",
      "minLength": 1,
      "examples": [
        "cr_rising AND lactate_elevated",
        "aki_stage1 OR aki_stage2 OR aki_stage3",
        "NOT recovering AND deteriorating",
        "(fever OR hypothermia) AND tachycardia"
      ]
    },

    "severityLevel": {
      "type": "string",
      "enum": ["low", "medium", "high", "critical"],
      "description": "Clinical severity level for alerting and prioritization"
    },

    "mappingConfig": {
      "type": "object",
      "description": "Site-specific mappings for portability",
      "additionalProperties": false,
      "properties": {
        "source": {
          "type": "string",
          "description": "Reference to external mapping file",
          "examples": ["mappings/hospital_a.yaml", "mappings/omop_v5.yaml"]
        },
        "inline": {
          "type": "object",
          "description": "Inline concept mappings",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "concept_id": { "type": "integer" },
              "table": { "type": "string" },
              "value_column": { "type": "string" }
            }
          }
        }
      }
    }
  }
}
