# PSDL Schema Specification v0.1
# Patient Scenario Definition Language
#
# This file defines the YAML schema for PSDL v0.1
# Focus: Signals, Trends, Logic (no triggers/actions yet)

$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://psdl-lang.org/schema/v0.1"
title: "PSDL Scenario Schema v0.1"
description: "Schema for Patient Scenario Definition Language scenarios"

type: object
required:
  - scenario
  - version
  - signals
  - logic

properties:
  # ─────────────────────────────────────────────────────────────
  # METADATA
  # ─────────────────────────────────────────────────────────────
  scenario:
    type: string
    description: "Unique identifier for this scenario"
    pattern: "^[A-Za-z][A-Za-z0-9_-]*$"
    examples:
      - "ICU_Deterioration_v1"
      - "AKI_Detection"
      - "Sepsis_Early_Warning"

  version:
    type: string
    description: "Semantic version of this scenario definition"
    pattern: "^\\d+\\.\\d+\\.\\d+$"
    examples:
      - "0.1.0"
      - "1.0.0"

  description:
    type: string
    description: "Human-readable description of what this scenario detects"

  # ─────────────────────────────────────────────────────────────
  # POPULATION FILTER (Optional)
  # ─────────────────────────────────────────────────────────────
  population:
    type: object
    description: "Define which patients this scenario applies to"
    properties:
      include:
        type: array
        description: "Inclusion criteria (all must be true)"
        items:
          type: string
        examples:
          - ["age >= 18", "unit == 'ICU'"]
      exclude:
        type: array
        description: "Exclusion criteria (any excludes patient)"
        items:
          type: string
        examples:
          - ["status == 'comfort_care_only'"]

  # ─────────────────────────────────────────────────────────────
  # SIGNAL BINDINGS
  # ─────────────────────────────────────────────────────────────
  signals:
    type: object
    description: "Map logical signal names to data sources"
    additionalProperties:
      type: object
      required:
        - source
      properties:
        source:
          type: string
          description: "Source identifier (concept name, OMOP concept_id, or LOINC code)"
          examples:
            - "creatinine"
            - "3016723"
            - "LOINC:2160-0"
        concept_id:
          type: integer
          description: "OMOP concept_id (if known)"
        unit:
          type: string
          description: "Expected unit of measurement"
          examples:
            - "mg/dL"
            - "mmol/L"
            - "mmHg"
        domain:
          type: string
          description: "OMOP domain for this signal"
          enum:
            - measurement
            - condition
            - drug
            - procedure
            - observation
          default: measurement

  # ─────────────────────────────────────────────────────────────
  # TREND COMPUTATIONS
  # ─────────────────────────────────────────────────────────────
  trends:
    type: object
    description: "Define computed trends over signals"
    additionalProperties:
      type: object
      required:
        - expr
      properties:
        expr:
          type: string
          description: "Trend expression using PSDL operators"
          examples:
            - "delta(Cr, 6h) > 0.3"
            - "slope(Lact, 3h) > 0"
            - "ema(MAP, 30m) < 65"
            - "last(HR) > 100"
        description:
          type: string
          description: "Human-readable explanation of this trend"

  # ─────────────────────────────────────────────────────────────
  # LOGIC LAYER
  # ─────────────────────────────────────────────────────────────
  logic:
    type: object
    description: "Boolean logic combining trends into clinical states"
    additionalProperties:
      type: object
      required:
        - expr
      properties:
        expr:
          type: string
          description: "Boolean expression combining trends"
          examples:
            - "renal_rise AND lactate_rise"
            - "deterioration AND hypotension"
            - "aki_stage1 OR aki_stage2 OR aki_stage3"
        severity:
          type: string
          description: "Clinical severity level"
          enum:
            - low
            - medium
            - high
            - critical
        description:
          type: string
          description: "Clinical interpretation of this state"

  # ─────────────────────────────────────────────────────────────
  # MAPPING LAYER (for portability)
  # ─────────────────────────────────────────────────────────────
  mapping:
    type: object
    description: "Site-specific mappings (optional, can be external file)"
    properties:
      source:
        type: string
        description: "Reference to external mapping file"
        examples:
          - "mappings/hospital_a.yaml"
          - "mappings/omop_v5.yaml"
      inline:
        type: object
        description: "Inline concept mappings"
        additionalProperties:
          type: object
          properties:
            concept_id:
              type: integer
            table:
              type: string
            value_column:
              type: string

# ─────────────────────────────────────────────────────────────
# PSDL v0.1 OPERATORS REFERENCE
# ─────────────────────────────────────────────────────────────
#
# TEMPORAL WINDOW OPERATORS:
#   delta(signal, window)  - Absolute change over window
#   slope(signal, window)  - Linear regression slope
#   ema(signal, window)    - Exponential moving average
#   sma(signal, window)    - Simple moving average
#   min(signal, window)    - Minimum value in window
#   max(signal, window)    - Maximum value in window
#   count(signal, window)  - Observation count in window
#   last(signal)           - Most recent value
#   first(signal, window)  - First value in window
#
# WINDOW FORMATS:
#   30s  - 30 seconds
#   5m   - 5 minutes
#   2h   - 2 hours
#   1d   - 1 day
#   7d   - 7 days
#
# LOGICAL OPERATORS:
#   AND      - Logical conjunction
#   OR       - Logical disjunction
#   NOT      - Logical negation
#
# COMPARISON OPERATORS:
#   ==, !=   - Equality
#   <, <=    - Less than
#   >, >=    - Greater than
#
# ─────────────────────────────────────────────────────────────
